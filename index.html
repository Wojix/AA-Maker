<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AA Maker</title>

<style>
  body {
    margin: 0;
    padding: 20px;
    background: #f0f0f0;
    font-family: monospace;
    text-align: center;
    user-select: none;
  }

  #draw {
    border: 2px solid #444;
    background: #ffffff;
    cursor: crosshair;
    margin: 0 auto;
    display: block;
    touch-action: none;
  }

  #tools {
    margin: 20px 0;
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  label {
    font-size: 14px;
  }

  input {
    width: 60px;
    text-align: center;
    font-size: 16px;
  }

  button {
    padding: 7px 14px;
    border-radius: 6px;
    border: 1px solid #666;
    background: #fff;
    cursor: pointer;
  }

  button:hover {
    background: #e5e5e5;
  }

  #output {
    width: 90%;
    height: 200px;
    margin-top: 20px;
  }
</style>
</head>

<body>

<h1>AA Maker</h1>

<canvas id="draw" width="400" height="400"></canvas>

<div id="tools">

  <label>線の文字:</label>
  <input id="fgChar" maxlength="1" value="#" />

  <label>背景の文字:</label>
  <input id="bgChar" maxlength="1" value=" " />

  <label>横文字数:</label>
  <input id="aaWidth" type="number" min="10" max="200" value="80" />

  <label>縦文字数:</label>
  <input id="aaHeight" type="number" min="10" max="200" value="40" />

  <button onclick="exportAA()">AAに変換</button>
  <button onclick="downloadTxt()">txtでDL</button>
  <button onclick="clearCanvas()">全消し</button>
</div>

<textarea id="output" placeholder="ここにAAが出る"></textarea>

<script>
  const canvas = document.getElementById("draw");
  const ctx = canvas.getContext("2d");
  let drawing = false;

  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#000";

  function getPos(e) {
    if (e.touches) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: e.touches[0].clientX - rect.left,
        y: e.touches[0].clientY - rect.top
      };
    }
    return { x: e.offsetX, y: e.offsetY };
  }

  // マウス
  canvas.addEventListener("mousedown", e => {
    drawing = true;
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  });

  canvas.addEventListener("mousemove", e => {
    if (!drawing) return;
    const p = getPos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  });

  document.addEventListener("mouseup", () => drawing = false);

  // タッチ
  canvas.addEventListener("touchstart", e => {
    e.preventDefault();
    drawing = true;
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  });

  canvas.addEventListener("touchmove", e => {
    e.preventDefault();
    if (!drawing) return;
    const p = getPos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  });

  canvas.addEventListener("touchend", () => drawing = false);

  // AA変換
  function exportAA() {
    const fg = document.getElementById("fgChar").value || "#";
    const bg = document.getElementById("bgChar").value || " ";

    const w = parseInt(document.getElementById("aaWidth").value);
    const h = parseInt(document.getElementById("aaHeight").value);

    const cellW = canvas.width / w;
    const cellH = canvas.height / h;

    let result = "";

    for (let y = 0; y < h; y++) {
      let row = "";
      for (let x = 0; x < w; x++) {
        const px = ctx.getImageData(x * cellW, y * cellH, cellW, cellH);
        let sum = 0;

        for (let i = 0; i < px.data.length; i += 4) {
          if (px.data[i + 3] > 0) sum++;
        }

        row += sum > 5 ? fg : bg;
      }
      result += row + "\n";
    }

    output.value = result;
  }

  // txt ダウンロード
  function downloadTxt() {
    const text = output.value;
    const blob = new Blob([text], { type: "text/plain" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "aa.txt";
    a.click();

    URL.revokeObjectURL(url);
  }

  function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
</script>

</body>
</html>
